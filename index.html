<html>
    <head>
        <title>Stamp Calculator</title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    </head>
    <style>
        html {
            scroll-behavior: smooth;
        }
        .btn-primary {
            font-weight:300;
            background: #99bbff;
            color: black;
            border:thin black;
            padding:8px;
            width: 150px;
        }
        .btn-primary:hover {
            background: #337ab7;
            color:white;
        }
        input {
            border: 1px solid black;
            border-radius: 5px;
            padding: 4px;
        }
        table {
            font-family: arial, sans-serif;
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 8px;
        }
        td, th {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
            width: 70%;
        }
        tr:nth-child(even) {
            background-color: #dddddd;
        }
        .input-header {
            padding-bottom: 8px;
            margin-bottom: 0px;
            font-size: medium;
            font-weight: bold;
        }
        #header-created-by {
            text-align: left !important;
            padding-left: 8px;
        }
        #link-created-by {
            text-decoration: none;
            color: black;
            font-weight: 700
        }
        .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgb(0,0,0);
        background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        }
        #close-modal-use {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        #close-modal-use:hover,
        #close-modal-use:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        /* mobile screens */
        @media (min-width: 320px) and (max-width: 1024px) {
            .header-stamp-calculations {
                font-size: 75px;
                margin: 0px;
                padding: 50px;
                background-color: #99bbff;
            }
            .input-header {
                font-size: 35px !important;
                padding-bottom: 16px;
            }
            .stamp-header {
                font-size: 45px !important;
            }
            .btn-primary {
                width: 300px !important;
            }
            .modal-img {
                width: 60%;
                border: .5px solid black;
            }
            .modal-h3 {
                font-size: 55px;
            }
            .modal-h4 {
                font-size: 40px;
                font-weight: 350;
            }
            .modal-h5 {
                padding-top: 32px;
                font-size: 30px;
                font-weight: 350;
            }
            #stamp-calculator-inputs {
                width: 100%;
                margin-bottom: 250px;
                min-height: 78vh;
            }
            #stamp-calculator-outputs {
                width:100%;
                margin-bottom: 250px;
                min-height: 79vh;
            }
            #total-td {
                font-size: 40px;
            }
            #header-created-by {
                font-size: 30px;
            }
            th {
                font-size: 40px;
            }
            td {
                font-size: xx-large;
            }
            input {
                border: 2px solid black !important;
            }
            table {
                margin: 25px;
                width: 95% !important;
            }
            body {
                font-size: xx-large;
                text-align: center;
            }
        }
        /* desktop screens */
        @media (min-width: 1025px) {
            .header-stamp-calculations {
                font-size: xx-large;
                margin: 0px;
                padding: 40px;
                background-color: #99bbff;
            }
            #stamp-calculator-inputs {
                width:100%;
                margin-bottom: 50px;
                min-height: 90vh;
            }
            #stamp-calculator-outputs {
                width:100%;
                margin-bottom: 50px;
                min-height: 90vh;
            }
            #total-td {
                font-size: 25px;
            }
            .modal-img {
                width: 40%;
                border: .5px solid black;
            }
            .modal-h3 {
                font-size: 30px;
            }
            .modal-h4 {
                font-size: 20px;
                font-weight: 350;
            }
            .modal-h5 {
                padding-top: 32px;
                font-size: 15px;
                font-weight: 350;
            }
            th {
                font-size: 25px;
            }
            td {
                font-size: 17px;
            }
            table {
                margin: 25px;
                width: 95% !important;
            }
            body {
                text-align: center;
            }
        }
    </style>
    <script>
        // let userDefinedStamps = {};
        // if (document.cookie) {
        //     let cookieStamps = document.cookie.split("; ");
        //     for (var i = 0; i < cookieStamps.length; i++) {
        //         let cookieStamp = cookieStamps[i].split("=");
        //         userDefinedStamps[cookieStamp[0]] = cookieStamp[1];
        //     }
        // }

        // update stamp and set cookie
        // const updateStamp = (stampID, e) => {
        //     userDefinedStamps[stampID] = e.target.value;
        //     setCookie(stampID, e.target.value, 365);
        // }

        // set cookie
        // const setCookie = (cname, cvalue, exdays) => {
        //     const d = new Date();
        //     d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
        //     let expires = "expires="+d.toUTCString();
        //     document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
        // }

        // const deleteCookie = (cname) => {
        //     document.cookie = cname + '=; Max-Age=0'
        // }

        // get cookie
        // function getCookie(cname) {
        //     let name = cname + "=";
        //     let ca = document.cookie.split(';');
        //     for(let i = 0; i < ca.length; i++) {
        //         let c = ca[i];
        //         while (c.charAt(0) == ' ') {
        //         c = c.substring(1);
        //         }
        //         if (c.indexOf(name) == 0) {
        //         return c.substring(name.length, c.length);
        //         }
        //     }
        //     return "";
        // }

        document.addEventListener("DOMContentLoaded", function() {
            // define all text input fields
            let stampFields = 1;
            let stampFieldsDiv = document.getElementById("stamp-fields"); // div that holds stamp input fields
            let internationalStamp = document.getElementById("international-stamp"); // international stamp cost field
            let noPriceExceed = document.getElementById("no-price-exceed"); // price cannot exceed field
            let maxStamps = document.getElementById("max-stamps"); // max number of stamps field
            let stampCalculationsField = document.getElementById("stamp-calculations"); // div that holds stamp calculations

            // define modal and modal elements
            let modalUse = document.getElementById("modal-use");
            let btnModalUse = document.getElementById("btn-how-to-use");
            let closeModalUse = document.getElementById("close-modal-use");
            btnModalUse.onclick = function() {
                modalUse.style.display = "block";
            }
            closeModalUse.onclick = function() {
                modalUse.style.display = "none";
            }
            window.onclick = function(event) {
                if (event.target == modalUse) {
                    modalUse.style.display = "none";
                }
            }

            // define elements retrieved by document cookie
            // document.getElementById("stamp-field1").onchange = (e) => updateStamp(`stamp-field1`, e);
            // if (userDefinedStamps) {
            //     for (const stamp in userDefinedStamps) {
            //         if (stamp === "stamp-field1") {
            //             document.getElementById("stamp-field1").value = userDefinedStamps[stamp];
            //             continue;
            //         }
            //         if (!stamp.includes("stamp-field")) {
            //             document.getElementById(stamp).value = userDefinedStamps[stamp];
            //             continue
            //         }
            //         let newStamp = document.createElement("input");
            //         let lineBr = document.createElement("br");
            //         let secondLineBr = document.createElement("br");
            //         newStamp.type = "text";
            //         stampFields += 1;
            //         newStamp.id = stamp;
            //         newStamp.onchange = (e) => updateStamp(stamp, e);
            //         newStamp.value = userDefinedStamps[stamp];

            //         let removeStampBtn = document.createElement("button");
            //         removeStampBtn.innerText = "Remove Stamp";
            //         removeStampBtn.id = `stamp-remove${stamp.split('field')[1]}`;
            //         removeStampBtn.className = "btn-primary";
            //         removeStampBtn.style.marginLeft = "8px";
            //         removeStampBtn.onclick = function() {
            //             stampFieldsDiv.removeChild(newStamp);
            //             stampFieldsDiv.removeChild(removeStampBtn);
            //             stampFieldsDiv.removeChild(lineBr);
            //             stampFieldsDiv.removeChild(secondLineBr);
                        
            //             deleteCookie(`stamp-field${stamp.split('field')[1]}`);
            //         }

            //         // append new fields
            //         stampFieldsDiv.appendChild(newStamp);
            //         stampFieldsDiv.appendChild(removeStampBtn);
            //         stampFieldsDiv.appendChild(lineBr);
            //         stampFieldsDiv.appendChild(secondLineBr);
            //     }
            // }

            // add stamp button
            let btnAddStamp = document.getElementById("btn-add-stamp");
            btnAddStamp.onclick = function() {
                let newStamp = document.createElement("input");
                let lineBr = document.createElement("br");
                let secondLineBr = document.createElement("br");
                newStamp.type = "text";
                stampFields += 1;
                newStamp.id = `stamp-field${stampFields}`;
                // userDefinedStamps[`stamp-field${stampFields}`] = "";
                // newStamp.onchange = (e) => updateStamp(`stamp-field${stampFields}`, e);

                let removeStampBtn = document.createElement("button");
                removeStampBtn.innerText = "Remove Stamp";
                removeStampBtn.id = `stamp-remove${stampFields}`;
                removeStampBtn.className = "btn-primary";
                removeStampBtn.style.marginLeft = "8px";
                removeStampBtn.onclick = function() {
                    stampFieldsDiv.removeChild(newStamp);
                    stampFieldsDiv.removeChild(removeStampBtn);
                    stampFieldsDiv.removeChild(lineBr);
                    stampFieldsDiv.removeChild(secondLineBr);

                    // deleteCookie(`stamp-field${stampFields}`);
                }

                // append new fields
                stampFieldsDiv.appendChild(newStamp);
                stampFieldsDiv.appendChild(removeStampBtn);
                stampFieldsDiv.appendChild(lineBr);
                stampFieldsDiv.appendChild(secondLineBr);
            }

            // add calculations to right side of page
            function addCalculations(results) {
                stampCalculationsField.innerHTML = "";
                let header = document.createElement("h2");
                header.innerText = "Stamp Calculations:";
                header.className = "header-stamp-calculations";
                stampCalculationsField.appendChild(header);
                let postedResults = [];
                let selectedCurrency = document.getElementById("selected-currency").value;

                for (var i = 0; i < results.length; i++) {
                    if (postedResults.includes(`${results[i].size}-${results[i].price}-${results[i].overage.toFixed(5)}`)) {
                        continue;
                    }
                    postedResults.push(`${results[i].size}-${results[i].price}-${results[i].overage.toFixed(5)}`);

                    let stampHeader = document.createElement("h3");
                    stampHeader.className = "stamp-header";
                    if (results[i].stamps.length === 1) {
                        stampHeader.innerText = `Using ${results[i].size.toString()} Stamp`;
                    } else {
                        stampHeader.innerText = `Using ${results[i].size.toString()} Stamps`;
                    }
                    let lineBr = document.createElement("br");
                    if (i !== 0) {
                        if (results[i].size > results[i-1].size) {
                            stampCalculationsField.appendChild(lineBr);
                            stampCalculationsField.appendChild(stampHeader);
                        }
                    } else {
                        stampCalculationsField.appendChild(lineBr);
                        stampCalculationsField.appendChild(stampHeader);
                    }

                    let newStampsTable = document.createElement("table");
                    let newStampsTableHeadTR = document.createElement("tr");
                    let newStampsTableHeadTHStamp = document.createElement("th");
                    let newStampsTableHeadTHPrice = document.createElement("th");

                    newStampsTableHeadTHStamp.innerHTML = "Stamp";
                    newStampsTableHeadTHPrice.innerHTML = "Price";

                    newStampsTableHeadTR.appendChild(newStampsTableHeadTHStamp);
                    newStampsTableHeadTR.appendChild(newStampsTableHeadTHPrice);

                    newStampsTable.appendChild(newStampsTableHeadTR);

                    for (var j = 0; j < results[i].stamps.length; j++) {
                        let stampTR = document.createElement("tr");
                        let stampTDStamp = document.createElement("td");
                        let stampTDPrice = document.createElement("td");

                        stampTDStamp.innerHTML = results[i].stamps[j].stampName;
                        stampTDPrice.innerHTML = `${selectedCurrency}${results[i].stamps[j].stampVal.toFixed(2)}`;

                        stampTR.appendChild(stampTDStamp);
                        stampTR.appendChild(stampTDPrice);

                        newStampsTable.appendChild(stampTR);
                    }

                    let stampTR = document.createElement("tr");
                    let stampTDStamp = document.createElement("td");
                    let stampTDPrice = document.createElement("td");

                    stampTDStamp.innerHTML = "<b>Total</b>";
                    stampTDPrice.innerHTML = `${selectedCurrency}${results[i].price.toFixed(2)}`;
                    stampTDStamp.id = "total-td";

                    stampTR.appendChild(stampTDStamp);
                    stampTR.appendChild(stampTDPrice);

                    newStampsTable.appendChild(stampTR);

                    stampCalculationsField.appendChild(newStampsTable);
                    stampCalculationsField.scrollIntoView();
                }
            }

            let btnCalculate = document.getElementById("btn-calc");
            btnCalculate.onclick = function() {
                // get necessary values
                let internationalStampNum = parseFloat(internationalStamp.value);
                let noPriceExceedNum = parseFloat(noPriceExceed.value);
                let maxStampsNum = parseInt(maxStamps.value);
                let stamps = [];

                for (var i = 0; i < stampFields; i++) {
                    let stamp = document.getElementById(`stamp-field${i+1}`);
                    if (stamp) {
                        let stampValArray = stamp.value.split(' ');
                        let stampVal = parseFloat(stampValArray[0]);
                        stampValArray.shift();
                        let stampName = stampValArray.join(" ");
                        stamps.push({stampVal: stampVal, stampName: stampName });
                    }
                }

                let results = computeVals([], [], stamps, internationalStampNum, noPriceExceedNum, maxStampsNum);
                // setCookie("international-stamp", internationalStampNum.toString(), 365);
                // setCookie("no-price-exceed", noPriceExceedNum.toString(), 365);
                // setCookie("max-stamps", maxStampsNum.toString(), 365);
                let sortedResults = sortArr(results, results.length);
                addCalculations(sortedResults);
            }

            // An optimized version of Bubble Sort
            function sortArr(arr, arrSize) {
                var i, j;
                for (i = 0; i < arrSize-1; i++) {
                    for (j = 0; j < arrSize-i-1; j++) {
                        if (arr[j].size > arr[j+1].size) {
                            var temp = arr[j];
                            arr[j] = arr[j+1];
                            arr[j+1] = temp;
                        }
                    }
                }
                return arr;
            }

            // compute all the possible stamp outcomes
            function computeVals(found, trace, stamps, goalPrice, maxPrice, maxStamps, unique=false) {
                let newTrace = [...trace];

                // if no max price provided
                if (maxPrice < 0) {
                    return 0;
                }
                if (goalPrice <= 0) {
                    overage = -goalPrice
                    let price = 0;
                    for (var i = 0; i < newTrace.length; i++) {
                        price += newTrace[i].stampVal;
                    }
                    
                    found.push({"size":newTrace.length, "price":price, overage: overage, stamps:newTrace});
                    return
                }
                // if no max stamps number was provided
                if (maxStamps <= 0) {
                    return 0;
                }

                for (var i = 0; i < stamps.length; i++) {
                    newTrace.push(stamps[i]);

                    // is the stamp before this one worth exactly twice the value of this one?
                    // if so, this stamp should not occur more than once
                    make_this_unique = (i > 0) && (stamps[i - 1].stampVal == stamps[i].stampVal * 2);

                    // with the recursive call, exclude more expensive stamps; we already considered them
                    computeVals(found, newTrace, stamps.slice(-i), goalPrice - stamps[i].stampVal, maxPrice - stamps[i].stampVal, maxStamps - 1, make_this_unique)
                    newTrace.pop()
                }
                return found;
            }
        });
    </script>
    <body>
        <div id="stamp-calculator-inputs">
            <div>
                <h2 class="header-stamp-calculations">Stamp Calculator</h2>
            </div>
            <br/>
            <p style="text-align: right; padding-right: 16px">
                <button id="btn-how-to-use" class="btn-primary">How to Use</button>
                <select id="selected-currency" style="width: 100px !important" class="btn-primary">
                    <option value="$">$</option>
                    <option value="&#8364;">&#8364;</option>
                    <option value="&#165;">&#165;</option>
                    <option value="&#163;">&#163;</option>
                    <option value="&#8355;">&#8355;</option>
                    <option value="&#82;">&#82;</option>
                    <option value="&#122;&#322;">&#122;&#322;</option>
                    <option value="&#3647;">&#3647;</option>
                    <option value="&#107;&#114;">&#107;&#114;</option>
                    <option value="&#8377;">&#8377;</option>
                    <option value="&#82;&#112;">&#82;&#112;</option>
                    <option value="&#8362;">&#8362;</option>
                    <option value="&#8361;">&#8361;</option>
                    <option value="&#8372;">&#8372;</option>
                    <option value="&#1088;&#1091;&#1073;">&#1088;&#1091;&#1073;</option>
                </select>
            </p>
            <br/>
            <h4 class="input-header">Price of the Stamps Should Add Up To:</h4>
            <div>
                <input placeholder="1.45" type="text" id="international-stamp" />
            </div>
            <br/>
            <h4 class="input-header">Do Not Exceed the Price of:</h4>
            <div>
                <input placeholder="1.60" type="text" id="no-price-exceed" />
            </div>
            <br/>
            <h4 class="input-header">Max Number of Stamps You Want to Use:</h4>
            <div>
                <input placeholder="6" type="text" id="max-stamps" />
            </div>
            <br/>

            <span style="font-size: large;" class="input-header">Stamps:</span>
            <br/>
            <input placeholder="0.48 Postcard" type="text" id="stamp-field1" />
            <button class="btn-primary" id="btn-add-stamp">Add Stamp</button>
            <br/><br/>
            <div id="stamp-fields">
            </div>

            <br/><br/>
            <button class="btn-primary" id="btn-calc">Calculate</button>
        </div>
        <div id="stamp-calculator-outputs">
            <div id="stamp-calculations">
                <h2 class="header-stamp-calculations">Stamp Calculations:</h2>
            </div>
        </div>
        <!--<h4 id="header-created-by">Created by <a id="link-created-by" target="_blank" href="https://www.emilybolten.com/">Emily Bolten</a></h4>-->
    
        <div id="modal-use" class="modal">
            <div class="modal-content">
                <span id="close-modal-use">&times;</span>
                <h3 class="modal-h3">How to Use the Stamp Calculator</h3>
                <h4 class="modal-h4">This app is designed to get all possible stamp combinations to meet a given price.</h4>
                <br/>
                <h4 class="modal-h4">First, fill in the following fields:</h4>
                <h5 class="modal-h5"><b>Price of the Stamps Should Add Up To</b> - How much money you want your stamps to add up to.</h5>
                <img class="modal-img" src="UseImages/use-image1.png"/>
                <h5 class="modal-h5"><b>Do Not Exceed the Price of</b> - when stamps are combined, the combination should not cost more than the price you enter here.</h5>
                <img class="modal-img" src="UseImages/use-image2.png"/>
                <h5 class="modal-h5"><b>Max Number of Stamps You Want to Use</b> - when your stamps are combined, they should not use combinations of more stamps than the number you enter here.</h5>
                <img class="modal-img" src="UseImages/use-image3.png"/>
                <h5 class="modal-h5">Then under stamps, enter all the stamps you want to use to achieve the price. To add another stamp, click the <b>Add Stamp</b> button. To remove a stamp, click the <b>Remove Stamp</b> button. Enter stamps in the input field as shown in the image (price, then stamp name).</h5>
                <img class="modal-img" src="UseImages/use-image4.png"/>
                <h5 class="modal-h5">Then, click the calculate button.</h5>
                <img class="modal-img" src="UseImages/use-image5.png"/>
            </div>
        </div>
    </body>
</html>
